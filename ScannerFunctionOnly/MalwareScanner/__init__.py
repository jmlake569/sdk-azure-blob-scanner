import logging
import json
import tempfile
import requests
from datetime import datetime
import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from shared.scanner import Scanner  

def main(msg: str) -> None:
    logging.info(f'MalwareScanner processing message: {msg}')
    
    try:
        scan_request = json.loads(msg)
        blob_url = scan_request['blob_url']
        blob_name = scan_request['blob_name']
        
        with tempfile.NamedTemporaryFile(delete=False) as temp_file:
            response = requests.get(blob_url)
            temp_file.write(response.content)
            temp_file.flush()
            
            with Scanner() as scanner:
                results = scanner.scan_file(temp_file.name)
                
            logging.info(f'Scan results for {blob_name}: {results.to_dict()}')
            
    except Exception as e:
        logging.error(f'Error in MalwareScanner: {str(e)}')
        raise
